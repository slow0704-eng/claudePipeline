<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í† í”½ í”¼ë“œ</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* í”¼ë“œ í—¤ë” */
        .feed-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .feed-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .feed-subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        /* íŒ”ë¡œìš°í•œ í† í”½ ëª©ë¡ */
        .followed-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px 0;
            justify-content: center;
        }

        .topic-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background-color: rgba(255, 255, 255, 0.25);
            color: white;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .topic-badge:hover {
            background-color: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .topic-badge .topic-icon {
            font-size: 18px;
        }

        /* í”¼ë“œ ì•„ì´í…œ */
        .feed-list {
            display: grid;
            gap: 20px;
        }

        .feed-item {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .feed-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .feed-item-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .feed-item-topic {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            color: white;
        }

        .feed-item-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
            text-decoration: none;
            display: block;
            line-height: 1.4;
        }

        .feed-item-title:hover {
            color: #667eea;
        }

        .feed-item-content {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .feed-item-meta {
            color: #888;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .feed-item-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ë¹ˆ ìƒíƒœ */
        .no-content {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .no-content-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .no-content h3 {
            color: #333;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .no-content p {
            color: #666;
            margin-bottom: 25px;
            font-size: 15px;
        }

        .btn {
            display: inline-block;
            padding: 12px 28px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* ë¡œë”© ë”ë³´ê¸° ë²„íŠ¼ */
        .load-more-container {
            margin-top: 30px;
            text-align: center;
        }

        .btn-load-more {
            padding: 14px 32px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-load-more:hover:not(:disabled) {
            background-color: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-load-more:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* í•˜ë‹¨ ë²„íŠ¼ */
        .bottom-actions {
            margin-top: 40px;
            text-align: center;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .feed-header {
                padding: 30px 20px;
            }

            .feed-title {
                font-size: 28px;
            }

            .feed-item {
                padding: 20px;
            }

            .feed-item-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í”¼ë“œ í—¤ë” -->
        <div class="feed-header">
            <div class="feed-title">ğŸ“š í† í”½ í”¼ë“œ</div>
            <p class="feed-subtitle">íŒ”ë¡œìš°í•œ í† í”½ì˜ ìµœì‹  ê²Œì‹œê¸€ì„ í™•ì¸í•˜ì„¸ìš”</p>

            <!-- íŒ”ë¡œìš°í•œ í† í”½ ëª©ë¡ -->
            <div class="followed-topics" th:if="${followedTopics != null and !followedTopics.isEmpty()}">
                <a th:each="topic : ${followedTopics}"
                   th:href="@{/topics/{id}/feed(id=${topic.id})}"
                   class="topic-badge"
                   th:style="'background-color: ' + ${topic.color != null ? topic.color : 'rgba(255, 255, 255, 0.25)'}">
                    <span class="topic-icon" th:text="${topic.icon != null ? topic.icon : 'ğŸ“'}">ğŸ“</span>
                    <span th:text="${topic.name}">í† í”½</span>
                </a>
            </div>

            <div th:if="${followedTopicsCount != null}" style="margin-top: 15px; opacity: 0.85;">
                <span th:text="${followedTopicsCount} + 'ê°œì˜ í† í”½ íŒ”ë¡œìš° ì¤‘'">0ê°œì˜ í† í”½ íŒ”ë¡œìš° ì¤‘</span>
            </div>
        </div>

        <!-- í”¼ë“œ ì•„ì´í…œ ëª©ë¡ -->
        <div id="feedList" class="feed-list">
            <!-- ì´ˆê¸° í”¼ë“œ ë°ì´í„° -->
            <div th:each="item : ${initialFeed}" class="feed-item">
                <!-- í† í”½ íƒœê·¸ -->
                <div class="feed-item-topics" th:if="${item.topics != null and !item.topics.isEmpty()}">
                    <div th:each="topic : ${item.topics}"
                         class="feed-item-topic"
                         th:style="'background-color: ' + ${topic.color != null ? topic.color : '#667eea'}">
                        <span th:text="${topic.icon != null ? topic.icon : 'ğŸ“'}">ğŸ“</span>
                        <span th:text="${topic.name}">í† í”½</span>
                    </div>
                </div>

                <!-- ì œëª© -->
                <a th:href="@{/board/{id}(id=${item.boardId})}"
                   class="feed-item-title"
                   th:text="${item.title}">ê²Œì‹œê¸€ ì œëª©</a>

                <!-- ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° -->
                <div class="feed-item-content" th:text="${item.content}">
                    ê²Œì‹œê¸€ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°...
                </div>

                <!-- ë©”íƒ€ ì •ë³´ -->
                <div class="feed-item-meta">
                    <span>
                        <span>âœï¸</span>
                        <span th:text="${item.author}">ì‘ì„±ì</span>
                    </span>
                    <span>
                        <span>ğŸ“…</span>
                        <span th:text="${#temporals.format(item.createdAt, 'yyyy-MM-dd HH:mm')}">ë‚ ì§œ</span>
                    </span>
                    <span>
                        <span>ğŸ‘ï¸</span>
                        <span th:text="${item.viewCount}">0</span>
                    </span>
                    <span>
                        <span>â¤ï¸</span>
                        <span th:text="${item.likeCount}">0</span>
                    </span>
                    <span>
                        <span>ğŸ’¬</span>
                        <span th:text="${item.commentCount}">0</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- íŒ”ë¡œìš°í•œ í† í”½ì´ ì—†ì„ ë•Œ -->
        <div th:if="${followedTopics == null or followedTopics.isEmpty()}" class="no-content">
            <div class="no-content-icon">ğŸ“š</div>
            <h3>íŒ”ë¡œìš°í•œ í† í”½ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ê´€ì‹¬ìˆëŠ” í† í”½ì„ íŒ”ë¡œìš°í•˜ê³  ë§ì¶¤ í”¼ë“œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
            <a th:href="@{/board}" class="btn btn-primary">í† í”½ íƒìƒ‰í•˜ê¸°</a>
        </div>

        <!-- ê²Œì‹œê¸€ì´ ì—†ì„ ë•Œ -->
        <div th:if="${followedTopics != null and !followedTopics.isEmpty() and (initialFeed == null or initialFeed.isEmpty())}"
             class="no-content">
            <div class="no-content-icon">ğŸ“</div>
            <h3>ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>íŒ”ë¡œìš°í•œ í† í”½ì˜ ê²Œì‹œê¸€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>

        <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
        <div class="load-more-container" th:if="${initialFeed != null and initialFeed.size() >= 20}">
            <button id="loadMoreBtn" class="btn-load-more" onclick="loadMore()">
                ë” ë³´ê¸°
            </button>
        </div>

        <!-- í•˜ë‹¨ ë²„íŠ¼ -->
        <div class="bottom-actions">
            <a th:href="@{/board}" class="btn btn-secondary">ê²Œì‹œíŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let loading = false;
        const topicId = /*[[${topicId}]]*/ null;

        /**
         * ë” ë§ì€ í”¼ë“œ ì•„ì´í…œ ë¡œë“œ
         */
        async function loadMore() {
            if (loading) return;

            const btn = document.getElementById('loadMoreBtn');
            btn.disabled = true;
            btn.textContent = 'ë¡œë”© ì¤‘...';
            loading = true;

            try {
                // API ì—”ë“œí¬ì¸íŠ¸ ê²°ì •
                const apiUrl = topicId
                    ? `/api/topics/${topicId}/feed?page=${currentPage}&size=20`
                    : `/api/topics/feed?page=${currentPage}&size=20`;

                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('í”¼ë“œ ë¡œë“œ ì‹¤íŒ¨');
                }

                const data = await response.json();
                const items = data.items;

                if (items && items.length > 0) {
                    // í”¼ë“œ ì•„ì´í…œ ì¶”ê°€
                    const feedList = document.getElementById('feedList');
                    items.forEach(item => {
                        feedList.appendChild(createFeedItemElement(item));
                    });

                    currentPage++;

                    // ë” ì´ìƒ ë¡œë“œí•  ì•„ì´í…œì´ ì—†ìœ¼ë©´ ë²„íŠ¼ ìˆ¨ê¹€
                    if (!data.hasMore || items.length < 20) {
                        btn.style.display = 'none';
                    }
                } else {
                    btn.style.display = 'none';
                }

            } catch (error) {
                console.error('í”¼ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('í”¼ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ë” ë³´ê¸°';
                loading = false;
            }
        }

        /**
         * í”¼ë“œ ì•„ì´í…œ HTML ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
         */
        function createFeedItemElement(item) {
            const div = document.createElement('div');
            div.className = 'feed-item';

            // í† í”½ íƒœê·¸
            let topicsHtml = '';
            if (item.topics && item.topics.length > 0) {
                topicsHtml = '<div class="feed-item-topics">';
                item.topics.forEach(topic => {
                    const color = topic.color || '#667eea';
                    const icon = topic.icon || 'ğŸ“';
                    topicsHtml += `
                        <div class="feed-item-topic" style="background-color: ${color}">
                            <span>${icon}</span>
                            <span>${topic.name}</span>
                        </div>
                    `;
                });
                topicsHtml += '</div>';
            }

            // ë‚ ì§œ í¬ë§·íŒ…
            const createdAt = new Date(item.createdAt);
            const dateStr = createdAt.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            div.innerHTML = `
                ${topicsHtml}
                <a href="/board/${item.boardId}" class="feed-item-title">${item.title}</a>
                <div class="feed-item-content">${item.content || ''}</div>
                <div class="feed-item-meta">
                    <span><span>âœï¸</span><span>${item.author}</span></span>
                    <span><span>ğŸ“…</span><span>${dateStr}</span></span>
                    <span><span>ğŸ‘ï¸</span><span>${item.viewCount}</span></span>
                    <span><span>â¤ï¸</span><span>${item.likeCount}</span></span>
                    <span><span>ğŸ’¬</span><span>${item.commentCount}</span></span>
                </div>
            `;

            return div;
        }

        // ë¬´í•œ ìŠ¤í¬ë¡¤ (ì„ íƒì )
        /*
        window.addEventListener('scroll', () => {
            if (loading) return;

            const scrollPosition = window.innerHeight + window.scrollY;
            const threshold = document.documentElement.scrollHeight - 500;

            if (scrollPosition >= threshold) {
                const btn = document.getElementById('loadMoreBtn');
                if (btn && btn.style.display !== 'none') {
                    loadMore();
                }
            }
        });
        */
    </script>
</body>
</html>
