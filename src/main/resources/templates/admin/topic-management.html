<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<head>
    <title>í† í”½ ê´€ë¦¬ - ê´€ë¦¬ì</title>
    <th:block layout:fragment="extra-css">
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="page-header">
            <h1>ğŸ“ í† í”½ ê´€ë¦¬</h1>
            <p>ê³„ì¸µí˜• í† í”½ ë¶„ë¥˜ ì‹œìŠ¤í…œ</p>
        </div>

        <a th:href="@{/admin}" class="back-button">â† ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalTopics">-</div>
                <div class="stat-label">ì „ì²´ í† í”½</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeTopics">-</div>
                <div class="stat-label">í™œì„± í† í”½</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="level0Topics">-</div>
                <div class="stat-label">ìµœìƒìœ„ í† í”½</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="mergedTopics">-</div>
                <div class="stat-label">ë³‘í•©ëœ í† í”½</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('tree')">í† í”½ íŠ¸ë¦¬</button>
            <button class="tab" onclick="showTab('merged')">ë³‘í•© ì´ë ¥</button>
            <button class="tab" onclick="showTab('statistics')">í†µê³„</button>
        </div>

        <!-- Topic Tree Section -->
        <div id="treeSection" class="section">
            <div class="section-header">
                <span>í† í”½ ê³„ì¸µ êµ¬ì¡°</span>
                <button class="btn btn-primary" onclick="openCreateModal(null)">
                    + ìƒˆ í† í”½ ì¶”ê°€
                </button>
            </div>
            <div id="treeContent">
                <div class="loading">
                    <div class="spinner"></div>
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        </div>

        <!-- Merged Topics Section -->
        <div id="mergedSection" class="section" style="display: none;">
            <div class="section-header">ë³‘í•©ëœ í† í”½</div>
            <div id="mergedContent">
                <div class="loading">
                    <div class="spinner"></div>
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div id="statisticsSection" class="section" style="display: none;">
            <div class="section-header">í† í”½ í†µê³„</div>
            <div id="statisticsContent">
                <div class="loading">
                    <div class="spinner"></div>
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        </div>

        <!-- Create/Edit Topic Modal -->
        <div id="topicModal" class="modal">
            <div class="modal-content">
                <div class="modal-header" id="modalTitle">ìƒˆ í† í”½ ì¶”ê°€</div>
                <form id="topicForm" onsubmit="saveTopic(event)">
                    <input type="hidden" id="topicId">
                    <input type="hidden" id="topicParentId">

                    <div class="form-group">
                        <label>í† í”½ëª… *</label>
                        <input type="text" id="topicName" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label>ì„¤ëª…</label>
                        <textarea id="topicDescription" class="form-control"></textarea>
                    </div>

                    <div class="form-group">
                        <label>ì•„ì´ì½˜ (ì´ëª¨ì§€)</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="text" id="topicIcon" class="form-control"
                                   style="flex: 1;" placeholder="ì˜ˆ: ğŸ’»">
                            <button type="button" class="btn btn-secondary"
                                    onclick="toggleEmojiPicker()">ì„ íƒ</button>
                        </div>
                        <div id="emojiPicker" class="emoji-picker"></div>
                    </div>

                    <div class="form-group">
                        <label>ìƒ‰ìƒ</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="color" id="topicColor" value="#667eea">
                            <input type="text" id="topicColorHex" class="form-control"
                                   value="#667eea" style="flex: 1;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>í‘œì‹œ ìˆœì„œ</label>
                        <input type="number" id="topicDisplayOrder" class="form-control"
                               value="0" min="0">
                    </div>

                    <div class="form-group">
                        <label>ë©”ë‰´ íƒ€ì…</label>
                        <select id="topicMenuType" class="form-control">
                            <option value="MENU" selected>ë©”ë‰´</option>
                            <option value="BUTTON">ë²„íŠ¼</option>
                            <option value="DIVIDER">êµ¬ë¶„ì„ </option>
                        </select>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeTopicModal()">
                            ì·¨ì†Œ
                        </button>
                        <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Merge Modal -->
        <div id="mergeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">í† í”½ ë³‘í•©</div>
                <form id="mergeForm" onsubmit="executeMerge(event)">
                    <input type="hidden" id="mergeSourceId">

                    <div class="form-group">
                        <label>ì›ë³¸ í† í”½</label>
                        <input type="text" id="mergeSourceName" class="form-control" readonly>
                    </div>

                    <div class="form-group">
                        <label>ëŒ€ìƒ í† í”½ *</label>
                        <select id="mergeTargetId" class="form-control" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <textarea id="mergeNotes" class="form-control"></textarea>
                    </div>

                    <div class="alert alert-danger">
                        <strong>ì£¼ì˜:</strong> ë³‘í•© í›„ ì›ë³¸ í† í”½ì€ ë¹„í™œì„±í™”ë˜ë©°,
                        ëª¨ë“  ê²Œì‹œê¸€ì´ ëŒ€ìƒ í† í”½ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeMergeModal()">
                            ì·¨ì†Œ
                        </button>
                        <button type="submit" class="btn btn-warning">ë³‘í•© ì‹¤í–‰</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <th:block layout:fragment="extra-scripts">
        <script th:inline="javascript">
            // Common emojis for picker
            const commonEmojis = [
                'ğŸ’»', 'ğŸ“±', 'ğŸ¨', 'ğŸ®', 'ğŸ“š', 'ğŸµ', 'ğŸ¬', 'ğŸƒ',
                'ğŸ”', 'âœˆï¸', 'ğŸ ', 'ğŸ’¡', 'âš¡', 'ğŸŒŸ', 'ğŸ”¥', 'ğŸ’¼',
                'ğŸ“Š', 'ğŸ”§', 'ğŸ¯', 'ğŸš€', 'ğŸŒˆ', 'ğŸª', 'ğŸ­', 'ğŸ¨',
                'ğŸ“', 'ğŸŒ', 'ğŸ†', 'ğŸ’°', 'ğŸ“', 'ğŸ¥', 'ğŸš—', 'ğŸ¸'
            ];

            let allTopics = [];

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function() {
                loadAllData();
                initializeEmojiPicker();
                initializeColorPicker();
            });

            // Initialize emoji picker
            function initializeEmojiPicker() {
                const picker = document.getElementById('emojiPicker');
                commonEmojis.forEach(emoji => {
                    const option = document.createElement('div');
                    option.className = 'emoji-option';
                    option.textContent = emoji;
                    option.onclick = () => selectEmoji(emoji);
                    picker.appendChild(option);
                });
            }

            // Initialize color picker sync
            function initializeColorPicker() {
                const colorInput = document.getElementById('topicColor');
                const hexInput = document.getElementById('topicColorHex');

                colorInput.addEventListener('input', (e) => {
                    hexInput.value = e.target.value;
                });

                hexInput.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        colorInput.value = e.target.value;
                    }
                });
            }

            // Toggle emoji picker
            function toggleEmojiPicker() {
                const picker = document.getElementById('emojiPicker');
                picker.classList.toggle('show');
            }

            // Select emoji
            function selectEmoji(emoji) {
                document.getElementById('topicIcon').value = emoji;
                toggleEmojiPicker();
            }

            // Load all data
            async function loadAllData() {
                await Promise.all([
                    loadTopicTree(),
                    loadStatistics()
                ]);
            }

            // Load topic tree
            async function loadTopicTree() {
                try {
                    const response = await fetch('/admin/api/topics/tree');
                    const data = await response.json();

                    if (data.success) {
                        allTopics = flattenTree(data.topicTree);
                        renderTopicTree(data.topicTree);
                    } else {
                        showError('íŠ¸ë¦¬ ë¡œë“œ ì‹¤íŒ¨: ' + data.message);
                    }
                } catch (error) {
                    console.error('Failed to load topic tree:', error);
                    showError('íŠ¸ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // Flatten tree for easier access
            function flattenTree(tree) {
                let flat = [];
                function traverse(items) {
                    items.forEach(item => {
                        flat.push(item);
                        if (item.children) {
                            traverse(item.children);
                        }
                    });
                }
                traverse(tree);
                return flat;
            }

            // Render topic tree
            function renderTopicTree(tree) {
                const content = document.getElementById('treeContent');
                if (!tree || tree.length === 0) {
                    content.innerHTML = '<div class="no-data">í† í”½ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }

                content.innerHTML = '<ul class="tree-view">' + renderTreeItems(tree) + '</ul>';
            }

            // Render tree items recursively
            function renderTreeItems(items) {
                return items.map(item => `
                    <li class="tree-item level-${item.level}">
                        <div class="tree-item-content">
                            <div class="tree-item-info">
                                <span class="topic-icon">${item.icon || 'ğŸ“'}</span>
                                <span class="topic-color-preview"
                                      style="background-color: ${item.color || '#667eea'}"></span>
                                <div class="topic-details">
                                    <div class="topic-name">${item.name}</div>
                                    ${item.description ? `<div style="color: #666; font-size: 13px; margin-bottom: 4px;">${item.description}</div>` : ''}
                                    <div class="topic-meta">
                                        ë ˆë²¨: ${item.level} | ì‚¬ìš©: ${item.usageCount}íšŒ |
                                        <span class="badge ${item.enabled ? 'badge-enabled' : 'badge-disabled'}">
                                            ${item.enabled ? 'í™œì„±' : 'ë¹„í™œì„±'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="tree-item-actions">
                                ${item.level < 2 ? `
                                    <button class="btn btn-sm btn-success" onclick="openCreateModal(${item.id})">
                                        í•˜ìœ„ ì¶”ê°€
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-primary" onclick="openEditModal(${item.id})">
                                    ìˆ˜ì •
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="openMergeModal(${item.id}, '${item.name}')">
                                    ë³‘í•©
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTopic(${item.id})">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        ${item.children && item.children.length > 0 ? `
                            <ul class="tree-view">${renderTreeItems(item.children)}</ul>
                        ` : ''}
                    </li>
                `).join('');
            }

            // Load statistics
            async function loadStatistics() {
                try {
                    const response = await fetch('/admin/api/topics/statistics');
                    const data = await response.json();

                    if (data.success) {
                        const stats = data.statistics;
                        document.getElementById('totalTopics').textContent = stats.totalTopics || 0;
                        document.getElementById('activeTopics').textContent = stats.activeTopics || 0;
                        document.getElementById('level0Topics').textContent = stats.level0Topics || 0;
                        document.getElementById('mergedTopics').textContent = stats.mergedTopics || 0;
                    }
                } catch (error) {
                    console.error('Failed to load statistics:', error);
                }
            }

            // Show tab
            function showTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');

                // Update sections
                document.getElementById('treeSection').style.display = 'none';
                document.getElementById('mergedSection').style.display = 'none';
                document.getElementById('statisticsSection').style.display = 'none';

                if (tabName === 'tree') {
                    document.getElementById('treeSection').style.display = 'block';
                } else if (tabName === 'merged') {
                    document.getElementById('mergedSection').style.display = 'block';
                    loadMergedTopics();
                } else if (tabName === 'statistics') {
                    document.getElementById('statisticsSection').style.display = 'block';
                    loadDetailedStatistics();
                }
            }

            // Load merged topics
            async function loadMergedTopics() {
                const content = document.getElementById('mergedContent');
                content.innerHTML = '<div class="loading"><div class="spinner"></div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

                try {
                    const response = await fetch('/admin/api/topics/merge-history');
                    const data = await response.json();

                    if (data.success && data.history.length > 0) {
                        let html = '<table class="table"><thead><tr>';
                        html += '<th>ë³‘í•© ì¼ì‹œ</th><th>ì›ë³¸ í† í”½</th><th>ëŒ€ìƒ í† í”½</th><th>ì˜í–¥ ê²Œì‹œê¸€</th><th>ë©”ëª¨</th>';
                        html += '</tr></thead><tbody>';

                        data.history.forEach(h => {
                            const date = new Date(h.mergedAt).toLocaleString('ko-KR');
                            html += `<tr>
                                <td>${date}</td>
                                <td>${h.sourceTopicName}</td>
                                <td>${h.targetTopicName}</td>
                                <td>${h.boardsAffected}ê°œ</td>
                                <td>${h.notes || '-'}</td>
                            </tr>`;
                        });

                        html += '</tbody></table>';
                        content.innerHTML = html;
                    } else {
                        content.innerHTML = '<div class="no-data">ë³‘í•© ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    }
                } catch (error) {
                    console.error('Failed to load merge history:', error);
                    content.innerHTML = '<div class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>';
                }
            }

            // Load detailed statistics
            async function loadDetailedStatistics() {
                const content = document.getElementById('statisticsContent');
                content.innerHTML = '<div class="loading"><div class="spinner"></div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

                try {
                    const response = await fetch('/admin/api/topics/statistics');
                    const data = await response.json();

                    if (data.success) {
                        const stats = data.statistics;
                        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';

                        html += `
                            <div class="stat-card">
                                <div class="stat-value">${stats.totalTopics || 0}</div>
                                <div class="stat-label">ì „ì²´ í† í”½ ìˆ˜</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.activeTopics || 0}</div>
                                <div class="stat-label">í™œì„± í† í”½</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.mergedTopics || 0}</div>
                                <div class="stat-label">ë³‘í•©ëœ í† í”½</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.totalUsageCount || 0}</div>
                                <div class="stat-label">ì´ ì‚¬ìš© íšŸìˆ˜</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${(stats.averageUsageCount || 0).toFixed(1)}</div>
                                <div class="stat-label">í‰ê·  ì‚¬ìš© íšŸìˆ˜</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${stats.mostUsedTopicName || '-'}</div>
                                <div class="stat-label">ìµœë‹¤ ì‚¬ìš© í† í”½ (${stats.mostUsedTopicCount || 0}íšŒ)</div>
                            </div>
                        `;

                        html += '</div>';
                        content.innerHTML = html;
                    }
                } catch (error) {
                    console.error('Failed to load statistics:', error);
                    content.innerHTML = '<div class="no-data">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div>';
                }
            }

            // Open create modal
            function openCreateModal(parentId) {
                document.getElementById('modalTitle').textContent = parentId ? 'í•˜ìœ„ í† í”½ ì¶”ê°€' : 'ìƒˆ í† í”½ ì¶”ê°€';
                document.getElementById('topicId').value = '';
                document.getElementById('topicParentId').value = parentId || '';
                document.getElementById('topicName').value = '';
                document.getElementById('topicDescription').value = '';
                document.getElementById('topicIcon').value = 'ğŸ“';
                document.getElementById('topicColor').value = '#667eea';
                document.getElementById('topicColorHex').value = '#667eea';
                document.getElementById('topicDisplayOrder').value = '0';

                document.getElementById('topicModal').classList.add('show');
            }

            // Open edit modal
            function openEditModal(topicId) {
                const topic = allTopics.find(t => t.id === topicId);
                if (!topic) return;

                document.getElementById('modalTitle').textContent = 'í† í”½ ìˆ˜ì •';
                document.getElementById('topicId').value = topic.id;
                document.getElementById('topicParentId').value = topic.parentId || '';
                document.getElementById('topicName').value = topic.name;
                document.getElementById('topicDescription').value = topic.description || '';
                document.getElementById('topicIcon').value = topic.icon || 'ğŸ“';
                document.getElementById('topicColor').value = topic.color || '#667eea';
                document.getElementById('topicColorHex').value = topic.color || '#667eea';
                document.getElementById('topicDisplayOrder').value = topic.displayOrder || 0;

                document.getElementById('topicModal').classList.add('show');
            }

            // Close topic modal
            function closeTopicModal() {
                document.getElementById('topicModal').classList.remove('show');
            }

            // Save topic
            async function saveTopic(event) {
                event.preventDefault();

                const topicId = document.getElementById('topicId').value;
                const data = {
                    name: document.getElementById('topicName').value,
                    description: document.getElementById('topicDescription').value,
                    parentId: document.getElementById('topicParentId').value || null,
                    icon: document.getElementById('topicIcon').value,
                    color: document.getElementById('topicColorHex').value,
                    displayOrder: parseInt(document.getElementById('topicDisplayOrder').value)
                };

                try {
                    const url = topicId ? `/admin/api/topics/${topicId}` : '/admin/api/topics';
                    const method = topicId ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        closeTopicModal();
                        loadAllData();
                    } else {
                        alert('ì˜¤ë¥˜: ' + result.message);
                    }
                } catch (error) {
                    console.error('Failed to save topic:', error);
                    alert('í† í”½ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // Delete topic
            async function deleteTopic(topicId) {
                if (!confirm('ì •ë§ ì´ í† í”½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                try {
                    const response = await fetch(`/admin/api/topics/${topicId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        loadAllData();
                    } else {
                        alert('ì˜¤ë¥˜: ' + result.message);
                    }
                } catch (error) {
                    console.error('Failed to delete topic:', error);
                    alert('í† í”½ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // Open merge modal
            function openMergeModal(sourceId, sourceName) {
                document.getElementById('mergeSourceId').value = sourceId;
                document.getElementById('mergeSourceName').value = sourceName;
                document.getElementById('mergeNotes').value = '';

                // Populate target dropdown
                const targetSelect = document.getElementById('mergeTargetId');
                targetSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

                allTopics.filter(t => t.id !== sourceId && t.enabled && !t.mergedIntoId).forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.textContent = `${t.icon || 'ğŸ“'} ${t.name} (${t.usageCount}íšŒ)`;
                    targetSelect.appendChild(option);
                });

                document.getElementById('mergeModal').classList.add('show');
            }

            // Close merge modal
            function closeMergeModal() {
                document.getElementById('mergeModal').classList.remove('show');
            }

            // Execute merge
            async function executeMerge(event) {
                event.preventDefault();

                const data = {
                    sourceId: parseInt(document.getElementById('mergeSourceId').value),
                    targetId: parseInt(document.getElementById('mergeTargetId').value),
                    notes: document.getElementById('mergeNotes').value
                };

                if (!confirm('ë³‘í•©ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

                try {
                    const response = await fetch('/admin/api/topics/merge', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        closeMergeModal();
                        loadAllData();
                    } else {
                        alert('ì˜¤ë¥˜: ' + result.message);
                    }
                } catch (error) {
                    console.error('Failed to merge topics:', error);
                    alert('í† í”½ ë³‘í•©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // Show error
            function showError(message) {
                const content = document.getElementById('treeContent');
                content.innerHTML = `<div class="no-data" style="color: #cc0000;">${message}</div>`;
            }
        </script>
    </th:block>
</body>
</html>
