<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•´ì‹œíƒœê·¸ ë¶„ì„ - ê´€ë¦¬ì</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- WordCloud2.js -->
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>

</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ“Š í•´ì‹œíƒœê·¸ ë¶„ì„</h1>
            <p class="subtitle">í•´ì‹œíƒœê·¸ íŠ¸ë Œë“œ, í†µê³„ ë° ê´€ë ¨ì„± ë¶„ì„</p>
            <div class="nav-links">
                <a href="/admin/dashboard">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/admin/hashtags">í•´ì‹œíƒœê·¸ ê´€ë¦¬</a>
                <a href="/board">ê²Œì‹œíŒ</a>
            </div>
        </div>

        <!-- ì „ì²´ í†µê³„ -->
        <div class="stats-overview" id="statsOverview">
            <div class="stat-card">
                <div class="icon">ğŸ“Œ</div>
                <div class="label">ì „ì²´ í•´ì‹œíƒœê·¸</div>
                <div class="value" id="totalHashtags">-</div>
            </div>
            <div class="stat-card">
                <div class="icon">ğŸ“ˆ</div>
                <div class="label">ì´ ì‚¬ìš© íšŸìˆ˜</div>
                <div class="value" id="totalUsage">-</div>
            </div>
            <div class="stat-card">
                <div class="icon">ğŸ”¥</div>
                <div class="label">ì˜¤ëŠ˜ í™œì„± í•´ì‹œíƒœê·¸</div>
                <div class="value" id="activeToday">-</div>
            </div>
            <div class="stat-card">
                <div class="icon">âš¡</div>
                <div class="label">ì´ë²ˆ ì£¼ í™œì„±</div>
                <div class="value" id="activeThisWeek">-</div>
            </div>
        </div>

        <!-- íŠ¸ë Œë”© í•´ì‹œíƒœê·¸ (ì‹œê°„ëŒ€ë³„) -->
        <div class="section">
            <div class="section-header">
                <div>
                    <h2>ğŸ”¥ íŠ¸ë Œë”© í•´ì‹œíƒœê·¸</h2>
                    <p class="description">ì‹œê°„ëŒ€ë³„ ì¸ê¸° í•´ì‹œíƒœê·¸ ì¶”ì´</p>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('1hour')">1ì‹œê°„</button>
                <button class="tab" onclick="switchTab('1day')">24ì‹œê°„</button>
                <button class="tab" onclick="switchTab('7days')">7ì¼</button>
                <button class="tab" onclick="switchTab('30days')">30ì¼</button>
            </div>

            <div id="trending-1hour" class="tab-content active">
                <div id="trending-1hour-list" class="hashtag-list"></div>
            </div>
            <div id="trending-1day" class="tab-content">
                <div id="trending-1day-list" class="hashtag-list"></div>
            </div>
            <div id="trending-7days" class="tab-content">
                <div id="trending-7days-list" class="hashtag-list"></div>
            </div>
            <div id="trending-30days" class="tab-content">
                <div id="trending-30days-list" class="hashtag-list"></div>
            </div>
        </div>

        <!-- ì›Œë“œí´ë¼ìš°ë“œ -->
        <div class="section">
            <div class="section-header">
                <div>
                    <h2>â˜ï¸ í•´ì‹œíƒœê·¸ ì›Œë“œí´ë¼ìš°ë“œ</h2>
                    <p class="description">ì‚¬ìš© ë¹ˆë„ì— ë”°ë¥¸ ì‹œê°í™”</p>
                </div>
            </div>
            <canvas id="wordCloudCanvas"></canvas>
        </div>

        <!-- í•´ì‹œíƒœê·¸ë³„ ê²Œì‹œê¸€ ìˆ˜ í†µê³„ -->
        <div class="section">
            <div class="section-header">
                <div>
                    <h2>ğŸ“Š ê²Œì‹œê¸€ ìˆ˜ í†µê³„</h2>
                    <p class="description">í•´ì‹œíƒœê·¸ë³„ ê²Œì‹œê¸€ ê°œìˆ˜ (ìƒìœ„ 20ê°œ)</p>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="postCountChart"></canvas>
            </div>
        </div>

        <!-- ê´€ë ¨ í•´ì‹œíƒœê·¸ ì¶”ì²œ -->
        <div class="section">
            <div class="section-header">
                <div>
                    <h2>ğŸ”— ê´€ë ¨ í•´ì‹œíƒœê·¸ ì¶”ì²œ</h2>
                    <p class="description">í•¨ê»˜ ì‚¬ìš©ëœ í•´ì‹œíƒœê·¸ ë¶„ì„</p>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="relatedHashtagInput" placeholder="í•´ì‹œíƒœê·¸ ì…ë ¥ (ì˜ˆ: javascript)" />
                <button onclick="searchRelatedHashtags()">ê²€ìƒ‰</button>
            </div>

            <div id="relatedHashtagsResult"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let postCountChart = null;
        let trendingData = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadOverallStats();
            loadTrendingHashtags();
            loadWordCloud();
            loadPostCountStats();
        });

        // ì „ì²´ í†µê³„ ë¡œë“œ
        async function loadOverallStats() {
            try {
                const response = await fetch('/api/hashtags/overall-stats');
                const stats = await response.json();

                document.getElementById('totalHashtags').textContent =
                    (stats.totalHashtags || 0).toLocaleString();
                document.getElementById('totalUsage').textContent =
                    (stats.totalUsage || 0).toLocaleString();
                document.getElementById('activeToday').textContent =
                    (stats.activeToday || 0).toLocaleString();
                document.getElementById('activeThisWeek').textContent =
                    (stats.activeThisWeek || 0).toLocaleString();
            } catch (error) {
                console.error('ì „ì²´ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // íŠ¸ë Œë”© í•´ì‹œíƒœê·¸ ë¡œë“œ
        async function loadTrendingHashtags() {
            try {
                const response = await fetch('/api/hashtags/trending-by-period');
                trendingData = await response.json();

                displayTrending('1hour', trendingData['1hour'] || []);
                displayTrending('1day', trendingData['1day'] || []);
                displayTrending('7days', trendingData['7days'] || []);
                displayTrending('30days', trendingData['30days'] || []);
            } catch (error) {
                console.error('íŠ¸ë Œë”© í•´ì‹œíƒœê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        function displayTrending(period, data) {
            const container = document.getElementById(`trending-${period}-list`);

            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            container.innerHTML = data.map(tag => `
                <div class="hashtag-item">
                    <div class="tag-name">#${tag.name}</div>
                    <div class="tag-stats">
                        <span>ğŸ“ ${tag.postCount}ê°œ ê²Œì‹œê¸€</span>
                        <span>ğŸ”„ ${tag.useCount}íšŒ ì‚¬ìš©</span>
                    </div>
                </div>
            `).join('');
        }

        function switchTab(period) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // ì„ íƒí•œ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(`trending-${period}`).classList.add('active');
        }

        // ì›Œë“œí´ë¼ìš°ë“œ ë¡œë“œ
        async function loadWordCloud() {
            try {
                const response = await fetch('/api/hashtags/wordcloud?limit=100');
                const result = await response.json();
                const data = result.data || [];

                if (data.length === 0) {
                    document.getElementById('wordCloudCanvas').style.display = 'none';
                    return;
                }

                // WordCloud2.js í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const wordList = data.map(item => [item.name, item.value]);

                WordCloud(document.getElementById('wordCloudCanvas'), {
                    list: wordList,
                    gridSize: Math.round(16 * window.devicePixelRatio),
                    weightFactor: function(size) {
                        return Math.pow(size, 0.8) * window.devicePixelRatio * 3;
                    },
                    fontFamily: 'Segoe UI, sans-serif',
                    color: function() {
                        const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    rotateRatio: 0.3,
                    rotationSteps: 2,
                    backgroundColor: '#ffffff',
                    drawOutOfBound: false
                });
            } catch (error) {
                console.error('ì›Œë“œí´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê²Œì‹œê¸€ ìˆ˜ í†µê³„ ì°¨íŠ¸
        async function loadPostCountStats() {
            try {
                const response = await fetch('/api/hashtags/post-count-stats?limit=20');
                const result = await response.json();
                const stats = result.stats || [];

                if (stats.length === 0) return;

                const labels = stats.map(s => '#' + s.name);
                const data = stats.map(s => s.postCount);

                const ctx = document.getElementById('postCountChart').getContext('2d');

                if (postCountChart) {
                    postCountChart.destroy();
                }

                postCountChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ê²Œì‹œê¸€ ìˆ˜',
                            data: data,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 'flex',
                            maxBarThickness: 50
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y + 'ê°œ ê²Œì‹œê¸€';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ê²Œì‹œê¸€ ìˆ˜ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê´€ë ¨ í•´ì‹œíƒœê·¸ ê²€ìƒ‰
        async function searchRelatedHashtags() {
            const input = document.getElementById('relatedHashtagInput').value.trim();
            const resultDiv = document.getElementById('relatedHashtagsResult');

            if (!input) {
                alert('í•´ì‹œíƒœê·¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            // # ì œê±°
            const tag = input.replace('#', '');

            resultDiv.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

            try {
                const response = await fetch(`/api/hashtags/related?tag=${encodeURIComponent(tag)}&limit=15`);
                const result = await response.json();
                const related = result.related || [];

                if (related.length === 0) {
                    resultDiv.innerHTML = `
                        <p style="text-align: center; color: #999; padding: 40px;">
                            #${tag}ì™€ ê´€ë ¨ëœ í•´ì‹œíƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤
                        </p>
                    `;
                    return;
                }

                resultDiv.innerHTML = `
                    <h3 style="margin-bottom: 20px; color: #333;">
                        #${tag}ì™€ í•¨ê»˜ ì‚¬ìš©ëœ í•´ì‹œíƒœê·¸ (${related.length}ê°œ)
                    </h3>
                    <div class="hashtag-list">
                        ${related.map(r => `
                            <div class="hashtag-item">
                                <div class="tag-name">#${r.name}</div>
                                <div class="tag-stats">
                                    <span>ğŸ”— ${r.coOccurrence}íšŒ í•¨ê»˜ ì‚¬ìš©</span>
                                    <span>ğŸ“ ${r.postCount}ê°œ ê²Œì‹œê¸€</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('ê´€ë ¨ í•´ì‹œíƒœê·¸ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                resultDiv.innerHTML = `
                    <p style="text-align: center; color: #ff5252; padding: 40px;">
                        ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                    </p>
                `;
            }
        }

        // Enter í‚¤ë¡œ ê²€ìƒ‰
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('relatedHashtagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchRelatedHashtags();
                }
            });
        });
    </script>
</body>
</html>
